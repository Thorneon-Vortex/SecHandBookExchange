å¥½çš„ï¼æˆ‘æ¥è¯¦ç»†è¯´æ˜ä¸€ä¸‹"éœ€è¦è®¤è¯"å’Œ"ä¸éœ€è¦è®¤è¯"çš„ä¸šåŠ¡åœ¨å®ç°ä¸Šçš„åŒºåˆ«ã€‚

[1 tool called]

å®Œç¾ï¼è®©æˆ‘é€šè¿‡å®é™…ä»£ç å¯¹æ¯”æ¥è¯´æ˜åŒºåˆ«ã€‚

## ğŸ“ ä»£ç å¯¹æ¯”ï¼šéœ€è¦è®¤è¯ vs ä¸éœ€è¦è®¤è¯

### 1ï¸âƒ£ **ä¸éœ€è¦è®¤è¯çš„æ¥å£** - ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®

**ç¤ºä¾‹ï¼šæµè§ˆä¹¦ç±åˆ—è¡¨ `GET /listings`**

```java:22:37:d:\code\databaseWork\SecHandBookExchange\src\main\java\com\tiancai\controller\BookAndListingController.java
    @GetMapping
    // 1. å°†è¿”å›å€¼ä» Result<PageResult> æ”¹ä¸ºä½ çš„ Result
    public Result searchListings(
            @RequestParam(required = false) String keyword,
            @RequestParam(required = false) Integer categoryId,
            @RequestParam(defaultValue = "time_desc") String sortBy,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer pageSize
    ) {
        // Serviceå±‚çš„é€»è¾‘å®Œå…¨ä¸å˜ï¼Œå®ƒè¿”å›ä¸€ä¸ª PageResult å¯¹è±¡
        PageResult pageResult = listingService.search(keyword, categoryId, sortBy, page, pageSize);

        // 2. è°ƒç”¨ä½ çš„ Result.success(Object) æ–¹æ³•
        // PageResult å¯¹è±¡ä¼šè¢«æ”¾å…¥ Result çš„ data å­—æ®µä¸­
        return Result.success(pageResult);
    }
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä¸éœ€è¦è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- âœ… ä¸è°ƒç”¨ `BaseContext.getCurrentId()`
- âœ… ç›´æ¥å¤„ç†ä¸šåŠ¡é€»è¾‘
- âœ… ç”¨æˆ·æ— éœ€ç™»å½•å³å¯è®¿é—®

---

### 2ï¸âƒ£ **éœ€è¦è®¤è¯çš„æ¥å£** - å¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®

**ç¤ºä¾‹ï¼šè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ `GET /users/me`**

```java:56:63:d:\code\databaseWork\SecHandBookExchange\src\main\java\com\tiancai\controller\UserController.java
    @GetMapping("/me")
    public Result getCurrentUser() {
        Integer currentUserId = BaseContext.getCurrentId();
        log.info("è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯, ID: {}", currentUserId);
        
        User user = userService.getUserInfoById(currentUserId);
        return Result.success(user);
    }
```

**ç‰¹ç‚¹ï¼š**
- âœ… **å…³é”®åŒºåˆ«**ï¼šè°ƒç”¨ `BaseContext.getCurrentId()` è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
- âœ… æ‹¦æˆªå™¨ä¼šéªŒè¯Tokenå¹¶è®¾ç½®ç”¨æˆ·IDåˆ°ThreadLocal
- âœ… å¿…é¡»æºå¸¦æœ‰æ•ˆçš„Tokenæ‰èƒ½è®¿é—®

---

### 3ï¸âƒ£ **æ ¸å¿ƒæœºåˆ¶è§£æ**

#### **æ‹¦æˆªå™¨é…ç½®** - å†³å®šå“ªäº›æ¥å£éœ€è¦è®¤è¯

```java:15:27:d:\code\databaseWork\SecHandBookExchange\src\main\java\com\tiancai\config\WebMvcConfig.java
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginInterceptor)
                .addPathPatterns("/**") // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
                .excludePathPatterns(
                        "/users/login",      // ç™»å½•
                        "/users/register",   // æ³¨å†Œ
                        "/listings",         // æµè§ˆä¹¦ç±åˆ—è¡¨ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
                        "/listings/*",       // è·å–ä¹¦ç±è¯¦æƒ…ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
                        "/categories"        // è·å–åˆ†ç±»ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
                ); 
    }
```

**å·¥ä½œåŸç†ï¼š**
- é»˜è®¤æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ `/**`
- `excludePathPatterns` ä¸­çš„è·¯å¾„**ä¸éœ€è¦è®¤è¯**
- å…¶ä»–è·¯å¾„éƒ½éœ€è¦é€šè¿‡æ‹¦æˆªå™¨éªŒè¯

---

#### **æ‹¦æˆªå™¨** - éªŒè¯Tokenå¹¶å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

```java:15:35:d:\code\databaseWork\SecHandBookExchange\src\main\java\com\tiancai\interceptor\LoginInterceptor.java
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String token = request.getHeader("Authorization");

        if (token == null || !token.startsWith("Bearer ")) {
            response.setStatus(401);
            return false;
        }

        token = token.substring(7);

        try {
            Claims claims = JwtUtils.parseToken(token);
            Integer userId = claims.get("userId", Integer.class);
            BaseContext.setCurrentId(userId);  // ğŸ”‘ å…³é”®ï¼šå°†userIdå­˜å…¥ThreadLocal
        } catch (Exception e) {
            response.setStatus(401);
            return false;
        }
        return true;
    }
```

---

### 4ï¸âƒ£ **å®Œæ•´çš„è¯·æ±‚æµç¨‹å¯¹æ¯”**

#### **ä¸éœ€è¦è®¤è¯çš„è¯·æ±‚æµç¨‹**
```
å®¢æˆ·ç«¯ â†’ GET /listings
   â†“
WebMvcConfig: æ£€æŸ¥ excludePathPatterns â†’ âœ… åŒ¹é…ï¼Œè·³è¿‡æ‹¦æˆªå™¨
   â†“
Controller: searchListings() â†’ ç›´æ¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â†“
è¿”å›ç»“æœ
```

#### **éœ€è¦è®¤è¯çš„è¯·æ±‚æµç¨‹**
```
å®¢æˆ·ç«¯ â†’ GET /users/me (å¸¦ Authorization: Bearer token)
   â†“
WebMvcConfig: æ£€æŸ¥ excludePathPatterns â†’ âŒ ä¸åŒ¹é…ï¼Œéœ€è¦æ‹¦æˆª
   â†“
LoginInterceptor: 
   1. æå– Authorization header
   2. éªŒè¯ Token
   3. è§£æ userId
   4. BaseContext.setCurrentId(userId) â†’ å­˜å…¥ ThreadLocal
   â†“
Controller: getCurrentUser() 
   â†’ BaseContext.getCurrentId() â†’ ä» ThreadLocal è·å– userId
   â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â†“
LoginInterceptor.afterCompletion():
   â†’ BaseContext.removeCurrentId() â†’ æ¸…ç† ThreadLocal
   â†“
è¿”å›ç»“æœ
```



## ğŸ“‹ æ€»ç»“ï¼šéœ€è¦è®¤è¯ vs ä¸éœ€è¦è®¤è¯çš„æ ¸å¿ƒåŒºåˆ«

### **å…³é”®ä»£ç å·®å¼‚å¯¹æ¯”è¡¨**

| å¯¹æ¯”é¡¹ | **ä¸éœ€è¦è®¤è¯** | **éœ€è¦è®¤è¯** |
|--------|---------------|-------------|
| **æ‹¦æˆªå™¨** | åœ¨ `excludePathPatterns` ä¸­æ’é™¤ | è¢«æ‹¦æˆªå™¨æ‹¦æˆªéªŒè¯Token |
| **è·å–ç”¨æˆ·ID** | âŒ ä¸éœ€è¦ | âœ… `BaseContext.getCurrentId()` |
| **è¯·æ±‚å¤´** | âŒ ä¸éœ€è¦æºå¸¦Token | âœ… å¿…é¡»æºå¸¦ `Authorization: Bearer <token>` |
| **ä½¿ç”¨åœºæ™¯** | å…¬å¼€æ•°æ®ï¼ˆæµè§ˆã€æœç´¢ï¼‰ | ä¸ªäººæ•°æ®ã€ä¿®æ”¹æ“ä½œ |

---

### **å®é™…ä»£ç å¯¹æ¯”**

#### âŒ **ä¸éœ€è¦è®¤è¯** - æµè§ˆä¹¦ç±åˆ—è¡¨
```java
@GetMapping
public Result searchListings(...) {
    // ç›´æ¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œä¸è·å–ç”¨æˆ·ä¿¡æ¯
    PageResult pageResult = listingService.search(...);
    return Result.success(pageResult);
}
```

#### âœ… **éœ€è¦è®¤è¯** - å‘å¸ƒä¹¦ç±
```java
@PostMapping
public Result createListing(@RequestBody ListingCreateDTO dto) {
    // ğŸ”‘ æ ¸å¿ƒåŒºåˆ«ï¼šè·å–å½“å‰ç™»å½•ç”¨æˆ·ID
    Integer currentUserId = BaseContext.getCurrentId();
    log.info("ç”¨æˆ· {} å‘å¸ƒæ–°ä¹¦ç±", currentUserId);
    
    Integer newListingId = listingService.create(dto, currentUserId);
    return Result.success(Map.of("listingId", newListingId));
}
```

---

### **é‡è¦ä¿®å¤**

æˆ‘è¿˜ä¿®å¤äº†ä¸€ä¸ªBugï¼š`POST /listings` å’Œ `DELETE /listings/{id}` ä¹‹å‰ä½¿ç”¨ç¡¬ç¼–ç çš„ `userId = 1`ï¼Œç°åœ¨å·²ç»æ”¹ä¸ºæ­£ç¡®ä½¿ç”¨ `BaseContext.getCurrentId()` ä»Tokenä¸­è·å–çœŸå®ç”¨æˆ·IDã€‚

**ä¿®æ”¹å‰ï¼š** âŒ
```java
Integer currentUserId = 1;  // ç¡¬ç¼–ç ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯ç”¨æˆ·1
```

**ä¿®æ”¹åï¼š** âœ…
```java
Integer currentUserId = BaseContext.getCurrentId();  // ä»Tokenè·å–çœŸå®ç”¨æˆ·ID
```

---

### **å·¥ä½œæµç¨‹å›¾**

```
ğŸ”“ ä¸éœ€è¦è®¤è¯ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ è·³è¿‡æ‹¦æˆªå™¨ â†’ Controllerç›´æ¥å¤„ç† â†’ è¿”å›ç»“æœ

ğŸ” éœ€è¦è®¤è¯ï¼š
å®¢æˆ·ç«¯è¯·æ±‚(å¸¦Token) â†’ æ‹¦æˆªå™¨éªŒè¯Token â†’ æå–userIdå­˜å…¥ThreadLocal 
â†’ Controllerè°ƒç”¨BaseContext.getCurrentId() â†’ å¤„ç†ä¸šåŠ¡ 
â†’ æ¸…ç†ThreadLocal â†’ è¿”å›ç»“æœ
```

é‡å¯åº”ç”¨åï¼Œæ‰€æœ‰æ¥å£éƒ½å°†æ­£ç¡®å·¥ä½œï¼æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ