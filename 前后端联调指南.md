# 🔗 前后端联调完整指南

## 📋 前置检查清单

在开始联调之前，请确认：

- ✅ MySQL数据库服务已启动
- ✅ 数据库密码是 `Wsf197107`
- ✅ 后端项目已编译
- ✅ 前端依赖已安装

---

## 🗄️ 第一步：初始化数据库（包含测试数据）

### 方法1：使用一键初始化脚本（推荐）

我已经为您准备好了完整的初始化脚本，包含所有表、触发器、存储过程和测试数据。

#### 1.1 使用MySQL客户端执行

```bash
# 在项目根目录执行
mysql -u root -pWsf197107 < init_database_all_in_one.sql
```

> **注意**: `-p` 和密码之间没有空格

#### 1.2 使用Navicat或DataGrip

1. 打开 `init_database_all_in_one.sql` 文件
2. 连接到MySQL数据库
3. 选择执行整个脚本
4. 等待执行完成

### 方法2：手动执行SQL

如果自动化脚本有问题，可以手动执行：

```sql
-- 1. 创建并使用数据库
CREATE DATABASE IF NOT EXISTS `sechandbookexchange` DEFAULT CHARACTER SET utf8mb4;
USE `sechandbookexchange`;

-- 2. 执行建表语句（复制 someDetailedFiles/建表语句.txt 的内容）

-- 3. 执行触发器创建（复制 create_triggers.sql 的内容）

-- 4. 执行存储过程创建（复制 create_stored_procedure.sql 的内容）

-- 5. 插入测试数据（见下方）
```

### 测试数据SQL

```sql
-- 插入测试分类
INSERT INTO `category` (category_name) VALUES 
('计算机'),
('文学小说'),
('外语学习'),
('经济管理'),
('数学'),
('物理'),
('历史'),
('艺术');

-- 插入测试用户（密码都是123456的MD5：e10adc3949ba59abbe56e057f20f883e）
INSERT INTO `user` (student_id, nickname, password, contact_info, credit_score) VALUES 
('21371001', '学霸小王', 'e10adc3949ba59abbe56e057f20f883e', 'QQ:123456', 100),
('21371002', '爱书的小李', 'e10adc3949ba59abbe56e057f20f883e', 'WeChat:abc123', 100),
('21371003', '书虫小张', 'e10adc3949ba59abbe56e057f20f883e', 'QQ:789012', 100);

-- 插入测试书籍
INSERT INTO `book` (isbn, title, author, publisher, publication_year, cover_image_url) VALUES 
('9787111216719', '数据库系统概念', 'Abraham Silberschatz', '机械工业出版社', '2006', 'https://example.com/db.jpg'),
('9787115428028', 'Python编程：从入门到实践', 'Eric Matthes', '人民邮电出版社', '2016', 'https://example.com/python.jpg'),
('9787302476344', '算法导论', 'Thomas H. Cormen', '清华大学出版社', '2013', 'https://example.com/algo.jpg'),
('9787115468123', 'Java核心技术卷I', 'Cay S. Horstmann', '人民邮电出版社', '2018', 'https://example.com/java.jpg'),
('9787115279460', '深入理解计算机系统', 'Randal E. Bryant', '机械工业出版社', '2011', 'https://example.com/csapp.jpg');

-- 关联书籍与分类
INSERT INTO `book_category` (book_id, category_id) VALUES 
(1, 1), (2, 1), (3, 1), (4, 1), (5, 1);

-- 插入测试发布信息
INSERT INTO `listing` (seller_id, book_id, price, condition_desc, listing_type, status, description) VALUES 
(1, 1, 35.50, '九成新', '出售', '在售', '几乎全新，笔记很少，附赠复习资料。'),
(2, 2, 45.00, '全新', '出售', '在售', '全新未拆封，买错了。'),
(1, 3, 0.00, '八成新', '赠送', '在售', '已经学完了，送给需要的同学。'),
(3, 4, 55.00, '九成新', '出售', '在售', '看过一遍，保存得很好。'),
(2, 5, 68.00, '八成新', '出售', '在售', '有少量笔记，不影响阅读。');
```

### 验证数据初始化成功

```sql
-- 检查各表数据量
SELECT 'user' AS 表名, COUNT(*) AS 记录数 FROM `user`
UNION ALL
SELECT 'category', COUNT(*) FROM `category`
UNION ALL
SELECT 'book', COUNT(*) FROM `book`
UNION ALL
SELECT 'listing', COUNT(*) FROM `listing`
UNION ALL
SELECT 'orders', COUNT(*) FROM `orders`;

-- 应该显示：
-- user: 3
-- category: 8
-- book: 5
-- listing: 5
-- orders: 0
```

---

## 🚀 第二步：启动后端服务

### 2.1 检查配置

确认 `SecHandBookExchange/src/main/resources/application.yml` 中的数据库密码是否正确：

```yaml
datasource:
  password: Wsf197107  # 确认是这个密码
```

### 2.2 启动后端

**方法1：使用IDE（推荐）**

1. 在IDEA中打开项目
2. 找到 `SecHandBookExchangeApplication.java`
3. 右键 → Run 'SecHandBookExchangeApplication'
4. 等待启动完成

**方法2：使用Maven命令**

```bash
cd SecHandBookExchange
mvn clean spring-boot:run
```

### 2.3 验证后端启动成功

启动成功后，应该看到类似输出：

```
Started SecHandBookExchangeApplication in 3.456 seconds
```

**测试后端接口：**

```bash
# 测试获取分类接口
curl http://localhost:8080/categories

# 应该返回JSON格式的分类数据
```

或在浏览器中访问：`http://localhost:8080/categories`

---

## 🎨 第三步：启动前端服务

### 3.1 安装前端依赖（首次）

```bash
cd frontend
npm install
```

### 3.2 启动前端

```bash
npm run dev
```

启动成功后会显示：

```
➜  Local:   http://localhost:3000/
```

### 3.3 验证前端启动成功

打开浏览器访问：`http://localhost:3000`

应该看到漂亮的首页界面。

---

## 🧪 第四步：完整功能测试

### 测试1：登录功能

1. 点击右上角"登录"按钮
2. 输入测试账号：
   ```
   学号：21371001
   密码：123456
   ```
3. 点击登录
4. **预期结果**：登录成功，跳转到首页，右上角显示用户昵称

### 测试2：查看书籍列表

1. 点击导航栏"书籍市场"
2. **预期结果**：显示5本测试书籍

### 测试3：搜索书籍

1. 在搜索框输入"数据库"
2. 点击搜索
3. **预期结果**：显示《数据库系统概念》

### 测试4：按分类筛选

1. 在分类下拉框选择"计算机"
2. **预期结果**：显示所有计算机类书籍（5本）

### 测试5：查看书籍详情

1. 点击任意一本书籍
2. **预期结果**：
   - 显示书籍详细信息
   - 显示卖家信息（昵称、信誉分、联系方式）
   - 有"立即购买"按钮

### 测试6：发布书籍

1. 点击"发布书籍"
2. 填写书籍信息：
   ```
   ISBN: 9787121345678
   书名: 测试书籍
   作者: 测试作者
   出版社: 测试出版社
   出版年份: 2023
   发布类型: 出售
   价格: 30.00
   新旧程度: 九成新
   描述: 这是一本测试书籍
   ```
3. 点击"发布"
4. **预期结果**：
   - 提示"发布成功"
   - 跳转到书籍列表
   - 能看到刚发布的书籍

### 测试7：购买书籍

1. 退出当前账号
2. 使用另一个账号登录：
   ```
   学号：21371002
   密码：123456
   ```
3. 找到刚才发布的书籍
4. 点击"立即购买"
5. 确认购买
6. **预期结果**：
   - 提示"下单成功"
   - 跳转到订单页面
   - 能看到订单，状态为"待确认"
   - 书籍状态变为"已预定"

### 测试8：查看订单

1. 点击"我的订单"
2. 切换"我买到的"和"我卖出的"
3. **预期结果**：
   - 买家视角能看到购买的订单
   - 卖家视角能看到卖出的订单

### 测试9：完成交易

1. 在订单列表中点击"确认完成"
2. 确认操作
3. **预期结果**：
   - 订单状态变为"已完成"
   - 买卖双方信誉分各+5
   - 书籍状态变为"已售出"

### 测试10：触发器验证

**测试自动更新书籍状态的触发器：**

```sql
-- 在数据库中查询
SELECT o.order_id, o.order_status, l.status 
FROM orders o
JOIN listing l ON o.listing_id = l.listing_id;

-- 应该看到：
-- 订单状态为"已完成"时，listing状态为"已售出"
```

**测试信誉分触发器：**

```sql
-- 查询完成交易的买卖双方信誉分
SELECT user_id, nickname, credit_score 
FROM user 
WHERE user_id IN (1, 2);

-- 应该看到信誉分增加了
```

### 测试11：取消订单

1. 创建一个新订单
2. 点击"取消订单"
3. 确认取消
4. **预期结果**：
   - 订单状态变为"已取消"
   - 书籍状态恢复为"在售"

### 测试12：个人中心

1. 点击用户名下拉菜单
2. 选择"个人中心"
3. **预期结果**：
   - 显示用户信息
   - 显示信誉积分
   - 显示注册时间

### 测试13：编辑个人信息

1. 在个人中心点击"编辑资料"
2. 修改昵称和联系方式
3. 保存
4. **预期结果**：
   - 提示"更新成功"
   - 信息已更新

---

## 🐛 常见问题排查

### 问题1：前端无法连接后端

**症状**：前端显示网络错误

**检查步骤**：

1. 确认后端是否启动：
   ```bash
   curl http://localhost:8080/categories
   ```

2. 检查浏览器控制台Network标签，查看请求是否发送

3. 检查Vite代理配置（vite.config.js）

**解决方案**：
- 确保后端在8080端口运行
- 确保前端代理配置正确

### 问题2：登录失败（401）

**原因**：密码加密方式不匹配

**检查**：
```sql
-- 查看数据库中的密码
SELECT student_id, password FROM user;

-- 应该是MD5值：e10adc3949ba59abbe56e057f20f883e
```

**解决方案**：
- 确保测试用户密码是MD5加密后的值
- 或者重新注册一个新用户

### 问题3：触发器不生效

**检查触发器是否存在**：
```sql
SHOW TRIGGERS;
```

**解决方案**：
- 如果没有触发器，执行 `create_triggers.sql`
- 如果有错误，删除后重新创建

### 问题4：存储过程调用失败

**检查存储过程**：
```sql
SHOW PROCEDURE STATUS WHERE Db = 'sechandbookexchange';
```

**测试存储过程**：
```sql
CALL complete_transaction(1, @code, @msg);
SELECT @code, @msg;
```

### 问题5：CORS跨域错误

**症状**：浏览器控制台显示CORS错误

**原因**：后端未配置CORS

**解决方案**：
在后端添加CORS配置（WebMvcConfig.java已配置）

---

## 📊 联调检查清单

完成以下所有测试即表示联调成功：

- [ ] 数据库已初始化（表、触发器、存储过程、测试数据）
- [ ] 后端服务正常启动（8080端口）
- [ ] 前端服务正常启动（3000端口）
- [ ] 能够登录测试账号
- [ ] 能够浏览书籍列表
- [ ] 能够搜索和筛选书籍
- [ ] 能够查看书籍详情
- [ ] 能够发布新书籍
- [ ] 能够创建订单
- [ ] 能够查看订单
- [ ] 能够完成交易（信誉分+5）
- [ ] 能够取消订单
- [ ] 触发器正常工作（自动更新状态）
- [ ] 能够编辑个人信息

---

## 🎉 成功标志

如果以上所有测试都通过，恭喜您，前后端联调成功！

您现在可以：
- ✅ 正常使用所有功能
- ✅ 开始实际业务测试
- ✅ 准备演示或答辩

---

## 📞 需要帮助？

如果遇到问题：

1. **查看日志**：
   - 后端日志（控制台输出）
   - 前端控制台（浏览器F12）
   - MySQL错误日志

2. **检查数据**：
   ```sql
   -- 查看所有表的数据
   SELECT * FROM user;
   SELECT * FROM category;
   SELECT * FROM book;
   SELECT * FROM listing;
   SELECT * FROM orders;
   ```

3. **重新初始化**：
   如果数据混乱，可以删除数据库重新初始化：
   ```sql
   DROP DATABASE sechandbookexchange;
   ```
   然后重新执行 `init_database_all_in_one.sql`

---

**祝您联调顺利！** 🚀

