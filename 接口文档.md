这份文档是为前端开发者或 API 调用者设计的，同时也为后端开发者提供了一个明确的实现蓝图。文档将遵循 OpenAPI (Swagger) 的常用规范格式。

---

### **校园二手书交易与分享平台 - API 接口文档 (V1.0)**

#### **1. 项目概述**

*   **项目名称**: 校园二手书交易与分享平台
*   **基础 URL (Base URL)**: `https://api.yourdomain.com/v1`
*   **数据格式**: 所有请求和响应的主体均为 `application/json` 格式。

#### **2. 认证 (Authentication)**

*   本项目采用 **JWT (JSON Web Token)** 进行认证。
*   用户通过登录接口 (`/users/login`) 获取 Token。
*   对于需要认证的接口，客户端必须在 HTTP 请求头 (Header) 中携带 `Authorization` 字段，格式为 `Bearer <your_jwt_token>`。
*   未提供 Token 或 Token 无效/过期的请求将返回 `401 Unauthorized` 错误。

#### **3. 标准响应格式**

为了便于客户端统一处理，所有 API 响应都遵循以下结构：

*   **成功响应 (HTTP Status: 200, 201)**
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": { ... } // `data` 字段包含具体返回的数据，可能为对象或数组
    }
    ```
*   **失败响应 (HTTP Status: 4xx, 5xx)**
    ```json
    {
      "code": 0,
      "msg": "具体的错误信息，如：参数格式不正确",
      "data": null
    }
    ```

---

### **接口详情**

### **模块一：用户模块 (User Module)**

#### **1.1 用户注册**
*   **功能**: 创建一个新用户账户。
*   **Endpoint**: `POST /users/register`
*   **认证**: 无需
*   **请求体 (Request Body)**:
    ```json
    {
      "studentId": "21371001",    // String, 必填, 学号
      "nickname": "爱书的同学",   // String, 必填, 昵称
      "password": "your_secure_password", // String, 必填
      "contactInfo": "QQ:123456" // String, 必填, 联系方式
    }
    ```
*   **成功响应 (201 Created)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": {
        "userId": 101,
        "studentId": "21371001"
      }
    }
    ```
*   **失败响应**:
    *   `400 Bad Request`: 参数校验失败（如字段缺失、格式错误）。
    *   `409 Conflict`: 学号已被注册。(`code`: 40901)
*   **后端逻辑**: 调用 `register_user` 存储过程。

#### **1.2 用户登录**
*   **功能**: 用户登录以获取认证 Token。
*   **Endpoint**: `POST /users/login`
*   **认证**: 无需
*   **请求体 (Request Body)**:
    ```json
    {
      "studentId": "21371001", // String, 必填
      "password": "your_secure_password"  // String, 必填
    }
    ```
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "userId": 101,
        "nickname": "爱书的同学"
      }
    }
    ```
*   **失败响应**:
    *   `400 Bad Request`: 参数缺失。
    *   `401 Unauthorized`: 学号或密码错误。

#### **1.3 获取当前用户信息**
*   **功能**: 获取当前已登录用户的详细信息。
*   **Endpoint**: `GET /users/me`
*   **认证**: **需要**
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": {
        "userId": 101,
        "studentId": "21371001",
        "nickname": "爱书的同学",
        "contactInfo": "QQ:123456",
        "creditScore": 105,
        "registerTime": "2025-09-10T10:00:00"
      }
    }
    ```

#### **1.4 更新当前用户信息**
*   **功能**: 更新已登录用户的个人信息（如昵称、联系方式）。
*   **Endpoint**: `PUT /users/me`
*   **认证**: **需要**
*   **请求体 (Request Body)**:
    ```json
    {
      "nickname": "改个新昵称",    // String, 可选
      "contactInfo": "WeChat:abcdefg" // String, 可选
    }
    ```
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": { ... } // 返回更新后的用户信息
    }
    ```

---

### **模块二：书籍与发布模块 (Book & Listing Module)**

#### **2.1 搜索/浏览书籍发布信息**
*   **功能**: 系统核心接口，用于发现书籍，支持分页、关键词搜索、分类筛选和排序。
*   **Endpoint**: `GET /listings`
*   **认证**: 无需
*   **查询参数 (Query Parameters)**:
    *   `keyword` (String, 可选): 搜索关键词，将匹配书名、作者、ISBN。
    *   `categoryId` (Integer, 可选): 按分类ID筛选。
    *   `sortBy` (String, 可选): 排序方式。可选值: `time_desc` (默认, 最新发布), `price_asc` (价格升序), `price_desc` (价格降序)。
    *   `page` (Integer, 可选, 默认1): 页码。
    *   `pageSize` (Integer, 可选, 默认10): 每页数量。
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": {
        "total": 58,
        "page": 1,
        "pageSize": 10,
        "items": [
          {
            "listingId": 1,
            "title": "数据库系统概念",
            "author": "Abraham Silberschatz",
            "price": 35.50,
            "listingType": "出售",
            "status": "在售",
            "coverImageUrl": "https://images.example.com/db.jpg",
            "sellerNickname": "学霸"
          }
        ]
      }
    }
    ```

#### **2.2 获取书籍发布详情**
*   **功能**: 查看某一个具体发布信息的完整内容。
*   **Endpoint**: `GET /listings/{id}`
*   **认证**: 无需
*   **路径参数 (Path Variable)**:
    *   `id` (Integer, 必填): 发布信息的ID (`listingId`)。
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": {
        "listingId": 1,
        "price": 35.50,
        "condition": "九成新",
        "listingType": "出售",
        "status": "在售",
        "postTime": "2025-09-12T09:30:00",
        "description": "几乎全新，笔记很少，附赠复习资料。",
        "seller": {
          "userId": 102,
          "nickname": "学霸",
          "creditScore": 120,
          "contactInfo": "QQ:654321"
        },
        "book": {
          "bookId": 201,
          "isbn": "9787111216719",
          "title": "数据库系统概念",
          "author": "Abraham Silberschatz",
          "publisher": "机械工业出版社"
        }
      }
    }
    ```
*   **失败响应**: `404 Not Found`: 发布信息不存在。

#### **2.3 发布新的书籍信息**
*   **功能**: 用户发布一本自己想要出售或赠送的书。
*   **Endpoint**: `POST /listings`
*   **认证**: **需要**
*   **请求体 (Request Body)**:
    ```json
    {
      "isbn": "9787111216719",
      "title": "数据库系统概念",
      "author": "Abraham Silberschatz",
      "publisher": "机械工业出版社",
      "publicationYear": "2006",
      "coverImageUrl": "https://images.example.com/db.jpg",
      "price": 35.50,
      "condition": "九成新",
      "listingType": "出售",
      "description": "几乎全新，笔记很少。"
    }
    ```
*   **重要说明**: 
    *   ⚠️ 请求体中**不需要**也**不应该**包含 `sellerId` 字段
    *   发布者ID (`sellerId`) 会从当前登录用户的Token中自动获取
    *   这是出于安全考虑，防止用户冒充他人发布书籍
*   **后端逻辑**: 根据ISBN检查`Book`表。如果书不存在，先创建`Book`记录，然后创建`Listing`记录。发布者ID从Token中获取。
*   **成功响应 (201 Created)**:
    ```json
    {
        "code": 1,
        "msg": "success",
        "data": { "listingId": 1 }
    }
    ```

#### **2.4 删除（下架）自己发布的书籍**
*   **功能**: 卖家将自己发布的书籍信息下架。
*   **Endpoint**: `DELETE /listings/{id}`
*   **认证**: **需要**
*   **路径参数 (Path Variable)**: `id` (Integer, 必填): 发布的 `listingId`。
*   **后端逻辑**: 逻辑删除，将`listing`表的`status`字段更新为“已下架”。
*   **成功响应 (200 OK)**:
    ```json
    { "code": 1, "msg": "success", "data": "下架成功" }
    ```
*   **失败响应**:
    *   `403 Forbidden`: 试图删除不属于自己的发布信息。
    *   `404 Not Found`: 发布信息不存在。

---

### **模块三：订单模块 (Order Module)**

#### **3.1 创建订单**
*   **功能**: 用户对某本书籍的发布信息下单。
*   **Endpoint**: `POST /orders`
*   **认证**: **需要**
*   **请求体 (Request Body)**:
    ```json
    {
      "listingId": 1 // Integer, 必填, 想要购买的书籍发布ID
    }
    ```
*   **后端逻辑**: 创建订单记录，并由`after_order_insert`触发器自动将书籍状态更新为“已预定”。
*   **成功响应 (201 Created)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": { "orderId": 501 }
    }
    ```
*   **失败响应**: `400 Bad Request`: 书籍状态不是“在售”（如已被预定或售出）。

#### **3.2 获取我的订单列表**
*   **功能**: 查看自己作为买家或卖家的所有订单。
*   **Endpoint**: `GET /orders`
*   **认证**: **需要**
*   **查询参数 (Query Parameters)**:
    *   `role` (String, 可选): 角色筛选。可选值: `buyer` (我是买家，默认), `seller` (我是卖家)。
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": [
        {
          "orderId": 501,
          "orderStatus": "待确认",
          "orderTime": "2025-09-13T14:00:00",
          "transactionPrice": 35.50,
          "bookTitle": "数据库系统概念",
          "counterpartyNickname": "学霸"
        }
      ]
    }
    ```

#### **3.3 确认交易完成**
*   **功能**: 买家或卖家确认线下交易已完成。
*   **Endpoint**: `PUT /orders/{id}/complete`
*   **认证**: **需要**
*   **路径参数 (Path Variable)**: `id` (Integer, 必填): 订单 `orderId`。
*   **后端逻辑**: 调用`complete_transaction`存储过程，确保事务原子性。触发器将自动更新双方信誉分。
*   **成功响应 (200 OK)**:
    ```json
    { "code": 1, "msg": "success", "data": "交易已成功完成！" }
    ```
*   **失败响应**: `403 Forbidden`: 非订单相关方操作。 `400 Bad Request`: 订单状态不正确。

#### **3.4 取消订单**
*   **功能**: 买家或卖家取消订单。
*   **Endpoint**: `PUT /orders/{id}/cancel`
*   **认证**: **需要**
*   **路径参数 (Path Variable)**: `id` (Integer, 必填): 订单 `orderId`。
*   **后端逻辑**: 更新订单状态为“已取消”。触发器将自动恢复书籍为“在售”状态。
*   **成功响应 (200 OK)**:
    ```json
    { "code": 1, "msg": "success", "data": "订单已取消" }
    ```
*   **失败响应**: `400 Bad Request`: 订单已完成，无法取消。

---

### **模块四：其他模块**

#### **4.1 获取所有书籍分类**
*   **功能**: 用于前端展示分类筛选列表。
*   **Endpoint**: `GET /categories`
*   **认证**: 无需
*   **成功响应 (200 OK)**:
    ```json
    {
      "code": 1,
      "msg": "success",
      "data": [
        { "categoryId": 1, "categoryName": "计算机" },
        { "categoryId": 2, "categoryName": "文学小说" },
        { "categoryId": 3, "categoryName": "外语学习" }
      ]
    }
    ```